
var ElementHelper=(function(){"use strict";function create(elementName,args){var element;args=args||{};element=document.createElement(elementName);Object.getOwnPropertyNames(args).forEach(function(name){if(typeof args[name]==="object"){Object.getOwnPropertyNames(args[name]).forEach(function(subName){element[name][subName]=args[name][subName];});}else{element[name]=args[name];}});return element;}
return{"create":create};}());var LZ77=(function(){"use strict";function put32BitNumber(value,array,index){array[index]=value&0xff;array[index+1]=(value>>8)&0xff;array[index+2]=(value>>16)&0xff;array[index+3]=value>>24;}
function put16BitNumber(value,array,index){array[index]=value&0xff;array[index+1]=(value>>8)&0xff;}
function compress(bytes,pointerLengthWidth){var compressedBytes,pointerPos,tempPointerPos,outputPointer,pointerLength,tempPointerLength,compressedPointer,outputSize,codingPos,outputLookaheadRef,lookBehind,lookAhead,pointerPosMax,pointerLengthMax;if(bytes.length<=11){return undefined;}
compressedBytes=new Uint8Array(bytes.length);pointerPosMax=Math.pow(2,16-pointerLengthWidth);pointerLengthMax=Math.pow(2,pointerLengthWidth);put32BitNumber(bytes.length,compressedBytes,0);compressedBytes[4]=pointerLengthWidth;for(codingPos=0,compressedPointer=5,outputSize=5;codingPos<bytes.length;codingPos+=1){pointerPos=0;pointerLength=0;for(tempPointerPos=1;(tempPointerPos<pointerPosMax)&&(tempPointerPos<=codingPos);tempPointerPos+=1){lookBehind=codingPos-tempPointerPos;lookAhead=codingPos;for(tempPointerLength=0;bytes[lookAhead]===bytes[lookBehind];tempPointerLength+=1,lookAhead+=1,lookBehind+=1){if(tempPointerLength===pointerLengthMax){break;}}
if(tempPointerLength>pointerLength){pointerPos=tempPointerPos;pointerLength=tempPointerLength;if(pointerLength===pointerLengthMax){break;}}}
codingPos+=pointerLength;if((codingPos===bytes.length)&&(pointerLength>0)){if(pointerLength===1){outputPointer=0;}else{outputPointer=(pointerPos<<pointerLengthWidth)|(pointerLength-2);}
outputLookaheadRef=codingPos-1;}else{outputPointer=pointerPos<<pointerLengthWidth;if(pointerLength>0){outputPointer|=pointerLength-1;}
outputLookaheadRef=codingPos;}
if(outputSize+3>=bytes.length){return undefined;}
put16BitNumber(outputPointer,compressedBytes,compressedPointer);compressedPointer+=2;compressedBytes[compressedPointer]=bytes[outputLookaheadRef];compressedPointer+=1;outputSize+=3;}
return compressedBytes.subarray(0,outputSize);}
function get32BitNumber(array,index){return array[index]+(array[index+1]<<8)+(array[index+2]<<16)+(array[index+3]<<24);}
function get16BitNumber(array,index){return array[index]+(array[index+1]<<8);}
function decompress(bytes){var pointerLengthWidth,inputPointer,pointerLength,pointerPos,pointerLengthMask,compressedPointer,codingPos,pointerOffset,decompressedSize,decompressedBytes;decompressedSize=get32BitNumber(bytes,0);decompressedBytes=new Uint8Array(decompressedSize);pointerLengthWidth=bytes[4];compressedPointer=5;pointerLengthMask=Math.pow(2,pointerLengthWidth)-1;for(codingPos=0;codingPos<decompressedSize;codingPos+=1){inputPointer=get16BitNumber(bytes,compressedPointer);compressedPointer+=2;pointerPos=inputPointer>>pointerLengthWidth;if(pointerPos>0){pointerLength=(inputPointer&pointerLengthMask)+1;}else{pointerLength=0;}
if(pointerPos){for(pointerOffset=codingPos-pointerPos;pointerLength>0;pointerLength-=1){decompressedBytes[codingPos]=decompressedBytes[pointerOffset];codingPos+=1;pointerOffset+=1;}}
decompressedBytes[codingPos]=bytes[compressedPointer];compressedPointer+=1;}
return decompressedBytes;}
return{"compress":compress,"decompress":decompress};}());var Loaders=(function(){"use strict";var COMPRESS_LZ77,UNDO_RESIZE;COMPRESS_LZ77=1;UNDO_RESIZE=2;function File(bytes){var pos,SAUCE_ID,COMNT_ID,commentCount;SAUCE_ID=new Uint8Array([0x53,0x41,0x55,0x43,0x45]);COMNT_ID=new Uint8Array([0x43,0x4F,0x4D,0x4E,0x54]);this.get=function(){if(pos>=bytes.length){throw"Unexpected end of file reached.";}
pos+=1;return bytes[pos-1];};this.get16=function(){var v;v=this.get();return v+(this.get()<<8);};this.get32=function(){var v;v=this.get();v+=this.get()<<8;v+=this.get()<<16;return v+(this.get()<<24);};this.getC=function(){return String.fromCharCode(this.get());};this.getS=function(num){var string;string="";while(num>0){string+=this.getC();num-=1;}
return string.replace(/\s+$/,"");};this.lookahead=function(match){var i;for(i=0;i<match.length;i+=1){if((pos+i===bytes.length)||(bytes[pos+i]!==match[i])){break;}}
return i===match.length;};this.read=function(num){var t;t=pos;num=num||this.size-pos;while((pos+=1)<this.size){num-=1;if(num===0){break;}}
return bytes.subarray(t,pos);};this.seek=function(newPos){pos=newPos;};this.peek=function(num){num=num||0;return bytes[pos+num];};this.getPos=function(){return pos;};this.eof=function(){return pos===this.size;};pos=bytes.length-128;if(this.lookahead(SAUCE_ID)){this.sauce={};this.getS(5);this.sauce.version=this.getS(2);this.sauce.title=this.getS(35);this.sauce.author=this.getS(20);this.sauce.group=this.getS(20);this.sauce.date=this.getS(8);this.sauce.fileSize=this.get32();this.sauce.dataType=this.get();this.sauce.fileType=this.get();this.sauce.tInfo1=this.get16();this.sauce.tInfo2=this.get16();this.sauce.tInfo3=this.get16();this.sauce.tInfo4=this.get16();this.sauce.comments=[];commentCount=this.get();this.sauce.flags=this.get();if(commentCount>0){pos=bytes.length-128-(commentCount*64)-5;if(this.lookahead(COMNT_ID)){this.getS(5);while(commentCount>0){this.sauce.comments.push(this.getS(64));commentCount-=1;}}}}
pos=0;if(this.sauce){if(this.sauce.fileSize>0&&this.sauce.fileSize<bytes.length){this.size=this.sauce.fileSize;}else{this.size=bytes.length-128;}}else{this.size=bytes.length;}}
function ScreenData(width){var imageData,maxY,pos;function binColor(ansiColor){switch(ansiColor){case 4:return 1;case 6:return 3;case 1:return 4;case 3:return 6;case 12:return 9;case 14:return 11;case 9:return 12;case 11:return 14;default:return ansiColor;}}
this.reset=function(){imageData=new Uint8Array(width*100*3);maxY=0;pos=0;};this.reset();this.raw=function(bytes){var i,j;maxY=Math.ceil(bytes.length/2/width);imageData=new Uint8Array(width*maxY*3);for(i=0,j=0;j<bytes.length;i+=3,j+=2){imageData[i]=bytes[j];imageData[i+1]=bytes[j+1]&15;imageData[i+2]=bytes[j+1]>>4;}};function extendImageData(y){var newImageData;newImageData=new Uint8Array(width*(y+100)*3+imageData.length);newImageData.set(imageData,0);imageData=newImageData;}
this.set=function(x,y,charCode,fg,bg){pos=(y*width+x)*3;if(pos>=imageData.length){extendImageData(y);}
imageData[pos]=charCode;imageData[pos+1]=binColor(fg);imageData[pos+2]=binColor(bg);if(y>maxY){maxY=y;}};this.getData=function(){return imageData.subarray(0,width*(maxY+1)*3);};this.getHeight=function(){return maxY+1;};this.rowLength=width*3;this.stripBlinking=function(){var i;for(i=2;i<imageData.length;i+=3){if(imageData[i]>=8){imageData[i]-=8;}}};}
function loadAnsi(bytes,icecolors){var file,escaped,escapeCode,j,code,values,columns,imageData,topOfScreen,x,y,savedX,savedY,foreground,background,bold,blink,inverse;file=new File(bytes);function resetAttributes(){foreground=7;background=0;bold=false;blink=false;inverse=false;}
resetAttributes();function newLine(){x=1;if(y===26-1){topOfScreen+=1;}else{y+=1;}}
function setPos(newX,newY){x=Math.min(columns,Math.max(1,newX));y=Math.min(26,Math.max(1,newY));}
x=1;y=1;topOfScreen=0;escapeCode="";escaped=false;columns=(file.sauce!==undefined)?file.sauce.tInfo1:80;imageData=new ScreenData(columns);function getValues(){return escapeCode.substr(1,escapeCode.length-2).split(";").map(function(value){var parsedValue;parsedValue=parseInt(value,10);return isNaN(parsedValue)?1:parsedValue;});}
while(!file.eof()){code=file.get();if(escaped){escapeCode+=String.fromCharCode(code);if((code>=65&&code<=90)||(code>=97&&code<=122)){escaped=false;values=getValues();if(escapeCode.charAt(0)==="["){switch(escapeCode.charAt(escapeCode.length-1)){case"A":y=Math.max(1,y-values[0]);break;case"B":y=Math.min(26-1,y+values[0]);break;case"C":if(x===columns){newLine();}
x=Math.min(columns,x+values[0]);break;case"D":x=Math.max(1,x-values[0]);break;case"H":if(values.length===1){setPos(1,values[0]);}else{setPos(values[1],values[0]);}
break;case"J":if(values[0]===2){x=1;y=1;imageData.reset();}
break;case"K":for(j=x-1;j<columns;j+=1){imageData.set(j,y-1+topOfScreen,0,0);}
break;case"m":for(j=0;j<values.length;j+=1){if(values[j]>=30&&values[j]<=37){foreground=values[j]-30;}else if(values[j]>=40&&values[j]<=47){background=values[j]-40;}else{switch(values[j]){case 0:resetAttributes();break;case 1:bold=true;break;case 5:blink=true;break;case 7:inverse=true;break;case 22:bold=false;break;case 25:blink=false;break;case 27:inverse=false;break;}}}
break;case"s":savedX=x;savedY=y;break;case"u":x=savedX;y=savedY;break;}}
escapeCode="";}}else{switch(code){case 10:newLine();break;case 13:if(file.peek()===0x0A){file.read(1);newLine();}
break;case 26:break;default:if(code===27&&file.peek()===0x5B){escaped=true;}else{if(!inverse){imageData.set(x-1,y-1+topOfScreen,code,bold?(foreground+8):foreground,(icecolors&&blink)?(background+8):background);}else{imageData.set(x-1,y-1+topOfScreen,code,bold?(background+8):background,(icecolors&&blink)?(foreground+8):foreground);}
x+=1;if(x===columns+1){newLine();}}}}}
return{"width":columns,"height":imageData.getHeight(),"data":imageData.getData(),"noblink":file.sauce?((file.sauce.flags&1)===1):false,"title":file.sauce?file.sauce.title:"","author":file.sauce?file.sauce.author:"","group":file.sauce?file.sauce.group:""};}
function loadXbin(bytes,noblink){var file,header,font,palette,red,green,blue,imageData,output,i,j;function XBinHeader(file){var flags;if(file.getS(4)!=="XBIN"){throw"File ID does not match.";}
if(file.get()!==26){throw"File ID does not match.";}
this.width=file.get16();this.height=file.get16();this.fontHeight=file.get();if(this.fontHeight===0||this.fontHeight>32){throw"Illegal value for the font height ("+this.fontHeight+").";}
flags=file.get();this.palette=((flags&1)===1);this.font=((flags&2)===2);if(this.fontHeight!==16&&!this.font){throw"A non-standard font size was defined, but no font information was included with the file.";}
this.compressed=((flags&4)===4);this.nonBlink=((flags&8)===8);this.char512=((flags&16)===16);}
function uncompress(file,width,height){var uncompressed,p,repeatAttr,repeatChar,count;uncompressed=new Uint8Array(width*height*2);i=0;while(i<uncompressed.length){p=file.get();count=p&63;switch(p>>6){case 1:for(repeatChar=file.get(),j=0;j<=count;j+=1){uncompressed[i]=repeatChar;i+=1;uncompressed[i]=file.get();i+=1;}
break;case 2:for(repeatAttr=file.get(),j=0;j<=count;j+=1){uncompressed[i]=file.get();i+=1;uncompressed[i]=repeatAttr;i+=1;}
break;case 3:for(repeatChar=file.get(),repeatAttr=file.get(),j=0;j<=count;j+=1){uncompressed[i]=repeatChar;i+=1;uncompressed[i]=repeatAttr;i+=1;}
break;default:for(j=0;j<=count;j+=1){uncompressed[i]=file.get();i+=1;uncompressed[i]=file.get();i+=1;}}}
return uncompressed;}
file=new File(bytes);header=new XBinHeader(file);if(header.palette){palette=[];for(i=0;i<16;i+=1){red=file.get();green=file.get();blue=file.get();palette.push([red,green,blue]);}}else{palette=undefined;}
if(header.font){font=file.read(header.fontHeight*256);}else{font=undefined;}
imageData=header.compressed?uncompress(file,header.width,header.height):file.read(header.width*header.height*2);if(!noblink&&header.nonBlink){imageData.stripBlinking();}
output=new Uint8Array(imageData.length/2*3);for(i=0,j=0;i<imageData.length;i+=2,j+=3){output[j]=imageData[i];output[j+1]=imageData[i+1]&15;output[j+2]=imageData[i+1]>>4;}
return{"width":header.width,"height":header.height,"data":output,"noblink":header.nonBlink,"font":font,"palette":palette,"fontWidth":8,"fontHeight":header.fontHeight,"title":file.sauce?file.sauce.title:"","author":file.sauce?file.sauce.author:"","group":file.sauce?file.sauce.group:""};}
function loadBin(bytes,noblink){var file,columns,imageData,data;file=new File(bytes);columns=160;imageData=new ScreenData(columns);imageData.raw(file.read());if(file.sauce){if((file.sauce.flags&1)&&!noblink){imageData.stripBlinking();}}
data=imageData.getData();return{"width":160,"height":data.length/3/columns,"data":data,"noblink":file.sauce?((file.sauce.flags&1)===1):false,"title":file.sauce?file.sauce.title:"","author":file.sauce?file.sauce.author:"","group":file.sauce?file.sauce.group:""};}
function get32BitNumber(array,index){return array[index]+(array[index+1]<<8)+(array[index+2]<<16)+(array[index+3]<<24);}
function get16BitNumber(array,index){return array[index]+(array[index+1]<<8);}
function getNullTerminatedString(array,index){var text;text="";while(array[index]!==0){text+=String.fromCharCode(array[index]);index+=1;}
return text;}
function decodeBlock(array,index){var header,length,compression,bytes,i;header="";for(i=0;i<4;i+=1){header+=String.fromCharCode(array[index]);index+=1;}
compression=array[index];index+=1;length=get32BitNumber(array,index);index+=4;bytes=array.subarray(index,index+length);if(compression===COMPRESS_LZ77){bytes=LZ77.decompress(bytes);}
return{"header":header,"bytes":bytes};}
function decompressImage(bytes){var decompressedImage,i,j;decompressedImage=new Uint8Array(bytes.length/2*3);for(i=0,j=0;i<bytes.length;i+=2,j+=3){decompressedImage[j]=bytes[i];decompressedImage[j+1]=bytes[i+1]&0xf;decompressedImage[j+2]=bytes[i+1]>>4;}
return decompressedImage;}
function decodeUndos(block){var queue,type,types,size,i,j,undoValue,screenValue,image;queue=[];types=[];i=0;while(i<block.bytes.length){undoValue=[];type=block.bytes[i];i+=1;types.push(type);size=get32BitNumber(block.bytes,i);i+=4;if(type===UNDO_RESIZE){undoValue.push(get16BitNumber(block.bytes,i));i+=2;undoValue.push(get16BitNumber(block.bytes,i));i+=2;image=decompressImage(block.bytes.subarray(i,undoValue[0]*undoValue[1]*2+i));i+=undoValue[0]*undoValue[1]*2;undoValue.push(image);}else{for(j=0;j<size;j+=1){screenValue=[];screenValue.push(block.bytes[i]);i+=1;screenValue.push(block.bytes[i]&0xf);screenValue.push(block.bytes[i]>>4);i+=1;screenValue.push(get32BitNumber(block.bytes,i));i+=4;undoValue.push(screenValue);}}
queue.push(undoValue);}
return{"queue":queue,"types":types};}
function decodeMetadata(block){var title,author,group;title=getNullTerminatedString(block.bytes,0);author=getNullTerminatedString(block.bytes,title.length+1);group=getNullTerminatedString(block.bytes,title.length+1+author.length+1);return{"title":title,"author":author,"group":group};}
function decodeImage(block){var width,height,noblink;width=get16BitNumber(block.bytes,0);height=get16BitNumber(block.bytes,2);noblink=(block.bytes[4]===1);return{"width":width,"height":height,"data":decompressImage(block.bytes.subarray(5,block.bytes.length)),"noblink":noblink};}
function decodeFont(block){return{"width":block.bytes[0],"height":block.bytes[1],"bytes":block.bytes.subarray(2,block.bytes.length)};}
function decodePalette(block){var palette,i;palette=[];for(i=0;i<48;i+=3){palette.push([block.bytes[i],block.bytes[i+1],block.bytes[i+2]]);}
return palette;}
function decodeStates(block){var currentColor,currentTool,i,states,uid,length;currentColor=block.bytes[0];currentTool=getNullTerminatedString(block.bytes,1);i=1+currentTool.length+1;states={};while(i<block.bytes.length){uid=getNullTerminatedString(block.bytes,i);i+=uid.length+1;length=get32BitNumber(block.bytes,i);i+=4;states[uid]=block.bytes.subarray(i,i+length);i+=length;}
return{"currentColor":currentColor,"currentTool":currentTool,"states":states};}
function loadNative(bytes,callback,noblink,editor,toolbar){var ansiBlock,i,block,blocks;ansiBlock=decodeBlock(bytes,0);if(ansiBlock.header==="ANSi"){blocks={};i=0;while(i<ansiBlock.bytes.length){block=decodeBlock(ansiBlock.bytes,i);i+=block.bytes.length+9;switch(block.header){case"DISP":blocks[block.header]=decodeImage(block);break;case"FONT":blocks[block.header]=decodeFont(block);break;case"PALE":blocks[block.header]=decodePalette(block);break;case"UNDO":blocks[block.header]=decodeUndos(block);break;case"TOOL":blocks[block.header]=decodeStates(block);break;case"META":blocks[block.header]=decodeMetadata(block);break;default:blocks[block.header]=block.bytes;}}}
if(editor===undefined&&!noblink&&blocks.DISP.noblink){for(i=2;i<blocks.IMAG.data.length;i+=3){if(blocks.DISP[i]>=8){blocks.DISP[i]-=8;}}}
blocks.DISP.title=blocks.META.title;blocks.DISP.author=blocks.META.author;blocks.DISP.group=blocks.META.group;if(blocks.FONT!==undefined){blocks.DISP.fontWidth=blocks.FONT.width;blocks.DISP.fontHeight=blocks.FONT.height;blocks.DISP.font=blocks.FONT.bytes;}
if(blocks.PALE!==undefined){blocks.DISP.palette=blocks.PALE;}
callback(blocks.DISP);if(editor!==undefined&&toolbar!==undefined){editor.setUndoHistory(blocks.UNDO.queue,blocks.UNDO.types);toolbar.giveFocus(blocks.TOOL.currentTool);toolbar.setStates(blocks.TOOL.states);editor.setCurrentColor(blocks.TOOL.currentColor);}}
function loadFile(file,callback,noblink,editor,toolbar){var extension,reader;extension=file.name.split(".").pop().toLowerCase();reader=new FileReader();reader.onload=function(readerData){var data;data=new Uint8Array(readerData.target.result);switch(extension){case"ansiedit":loadNative(data,callback,noblink,editor,toolbar);break;case"xb":callback(loadXbin(data,noblink));break;case"bin":callback(loadBin(data,noblink));break;default:callback(loadAnsi(data,noblink));}};reader.readAsArrayBuffer(file);}
function parseFontData(imageData){var fontWidth,fontHeight,i,j,k,pos,value,bytes,x,y;fontWidth=imageData.width/16;fontHeight=imageData.height/16;if((fontWidth===8)&&(imageData.height%16===0)&&(fontHeight>=1&&fontHeight<=32)){bytes=new Uint8Array(8*fontHeight*256/8);k=0;for(value=0;value<256;value+=1){x=(value%16)*fontWidth;y=Math.floor(value/16)*fontHeight;pos=(y*imageData.width+x)*4;i=j=0;while(i<fontWidth*fontHeight){bytes[k]=bytes[k]<<1;if(imageData.data[pos]>127){bytes[k]+=1;}
if((i+=1)%fontWidth===0){pos+=(imageData.width-8)*4;}
if(i%8===0){k+=1;}
pos+=4;}}
return{"width":fontWidth,"height":fontHeight,"bytes":bytes};}
return undefined;}
function convert8BitTo6Bit(rgb){return[Math.floor(rgb[0]/255*63),Math.floor(rgb[1]/255*63),Math.floor(rgb[2]/255*63)];}
function parsePaletteData(imageData){var i,x,y,index,palette,rgb;if(imageData.width===160&&imageData.height===40){palette=[];for(i=0;i<16;i+=1){x=(i%8)*imageData.width/8;y=(i<8)?imageData.height/2:0;index=(y*imageData.width+x)*4;rgb=imageData.data.subarray(index,index+3);rgb=convert8BitTo6Bit(rgb);palette.push(rgb);}
return palette;}
return undefined;}
function loadImageGetImageData(url,callback){var img;img=new Image();img.onload=function(){var canvas,ctx,imageData;canvas=ElementHelper.create("canvas",{"width":img.width,"height":img.height});ctx=canvas.getContext("2d");ctx.drawImage(img,0,0);imageData=ctx.getImageData(0,0,canvas.width,canvas.height);callback(imageData);};img.src=url;}
function loadFont(url,callback){loadImageGetImageData(url,function(imageData){var fontData;fontData=parseFontData(imageData);callback(fontData);});}
function loadPalette(url,callback){loadImageGetImageData(url,function(imageData){var paletteData;paletteData=parsePaletteData(imageData);callback(paletteData);});}
return{"loadFile":loadFile,"loadFont":loadFont,"loadPalette":loadPalette};}());var Savers=(function(){"use strict";var DATATYPE_CHARACTER,DATATYPE_XBIN,FILETYPE_NONE,FILETYPE_ANSI,FLAG_NONE,FLAG_PALETTE,FLAG_FONT,FLAG_NOBLINK;DATATYPE_CHARACTER=1;DATATYPE_XBIN=6;FILETYPE_NONE=0;FILETYPE_ANSI=1;FLAG_NONE=0;FLAG_PALETTE=1;FLAG_FONT=2;FLAG_NOBLINK=8;function saveFile(bytes,mimeType,filename){var downloadLink,blob,clickEvent,base64String,i;downloadLink=document.createElement("a");if((navigator.userAgent.indexOf("Chrome")===-1)&&(navigator.userAgent.indexOf("Safari")!==-1)){base64String="";for(i=0;i<bytes.length;i+=1){base64String+=String.fromCharCode(bytes[i]);}
downloadLink.href="data:"+mimeType+";base64,"+btoa(base64String);}else{blob=new Blob([bytes],{"type":mimeType});downloadLink.href=URL.createObjectURL(blob);}
downloadLink.download=filename;clickEvent=document.createEvent("MouseEvent");clickEvent.initEvent("click",true,true);downloadLink.dispatchEvent(clickEvent);}
function addText(sauce,text,maxlength,index){var i;for(i=0;i<maxlength;i+=1){sauce[i+index]=(i<text.length)?text.charCodeAt(i):0x20;}}
function createSauce(datatype,filetype,filesize,columns,rows,title,author,group,flags,fontName){var sauce,date,month,day;sauce=new Uint8Array(129);sauce[0]=26;sauce.set(new Uint8Array([0x53,0x41,0x55,0x43,0x45,0x30,0x30]),1);addText(sauce,title,35,8);addText(sauce,author,20,43);addText(sauce,group,20,63);date=new Date();addText(sauce,date.getFullYear().toString(10),4,83);month=date.getMonth()+1;addText(sauce,(month<10)?("0"+month.toString(10)):month.toString(10),2,87);day=date.getDate();addText(sauce,(day<10)?("0"+day.toString(10)):day.toString(10),2,89);sauce[91]=filesize&0xff;sauce[92]=(filesize>>8)&0xff;sauce[93]=(filesize>>16)&0xff;sauce[94]=filesize>>24;sauce[95]=datatype;sauce[96]=filetype;sauce[97]=columns&0xff;sauce[98]=columns>>8;sauce[99]=rows&0xff;sauce[100]=rows>>8;sauce[105]=0;sauce[106]=flags;if(fontName!==undefined){addText(sauce,fontName,fontName.length,107);}
return sauce;}
function imageDataToXBin(imageData,noblink,fontHeight,fontBytes,palette){var bytes,i,j,flags;bytes=new Uint8Array(11+fontBytes.length+48+(imageData.width*imageData.height*2));flags=(noblink?FLAG_NOBLINK:FLAG_NONE)|FLAG_FONT|FLAG_PALETTE;bytes.set(new Uint8Array([88,66,73,78,26,(imageData.width&0xff),(imageData.width>>8),(imageData.height&0xff),(imageData.height>>8),fontHeight,flags]),0);for(i=0,j=11;i<16;i+=1,j+=3){bytes[j]=palette[i][0];bytes[j+1]=palette[i][1];bytes[j+2]=palette[i][2];}
bytes.set(fontBytes,j);j+=fontBytes.length;for(i=0;i<imageData.data.length;i+=3,j+=2){bytes[j]=imageData.data[i];bytes[j+1]=imageData.data[i+1]+(imageData.data[i+2]<<4);}
return bytes;}
function saveXBinData(imageData,noblink,fontHeight,fontBytes,palette,title,author,group,filename){var xbin,sauce,combined;xbin=imageDataToXBin(imageData,noblink,fontHeight,fontBytes,palette);sauce=createSauce(DATATYPE_XBIN,FILETYPE_NONE,xbin.length,imageData.width,imageData.height,title,author,group,0,undefined);combined=new Uint8Array(xbin.length+sauce.length);combined.set(xbin,0);combined.set(sauce,xbin.length);saveFile(combined,"image/x-bin",filename);}
function dataUrlToBytes(dataURL){var base64Index,mimeType,byteChars,bytes,i;if(dataURL.indexOf("data:")===0){base64Index=dataURL.indexOf(";base64,");if(base64Index!==-1){mimeType=dataURL.substr(5,base64Index-5);base64Index+=8;byteChars=atob(dataURL.substr(base64Index,dataURL.length-base64Index));bytes=new Uint8Array(byteChars.length);for(i=0;i<bytes.length;i+=1){bytes[i]=byteChars.charCodeAt(i);}
return{"bytes":bytes,"mimeType":mimeType};}}
return undefined;}
function saveCanvas(canvas,filename){var data;data=dataUrlToBytes(canvas.toDataURL());if(data!==undefined){saveFile(data.bytes,data.mimeType,filename);}}
return{"saveFile":saveFile,"createSauce":createSauce,"DATATYPE_CHARACTER":DATATYPE_CHARACTER,"DATATYPE_XBIN":DATATYPE_XBIN,"FILETYPE_NONE":FILETYPE_NONE,"FILETYPE_ANSI":FILETYPE_ANSI,"saveXBinData":saveXBinData,"saveCanvas":saveCanvas};}());function toolbarWidget(editor){"use strict";var quickAccessPanel,quickFontAccessPanel,quickAccessDisplayed,quickFontAccessDisplayed,quickAccessOffset,quickFontAccessOffset,selected,shortcuts,functionShortcuts,tools,proMode,title,mousePos;shortcuts=[];functionShortcuts=[];tools={};proMode=false;quickAccessPanel=ElementHelper.create("div",{"className":"quick-access-panel"});quickFontAccessPanel=ElementHelper.create("div",{"className":"quick-access-panel fonts"});quickAccessDisplayed=false;quickFontAccessDisplayed=false;quickAccessOffset={"x":8,"y":8};quickFontAccessOffset={"x":8,"y":8};mousePos={"x":0,"y":0};function addTool(tool,elementId,keyCode,functionKeys){var div,divCanvasContainer,paragraph;function shortcutName(code,shiftKey){var keyName;switch(code){case 44:return"comma";case 32:return"space";default:keyName=String.fromCharCode(keyCode);return shiftKey?keyName+" / "+keyName.toUpperCase():keyName;}}
function updateStatus(){var title;title=tool.toString();if(keyCode){title+=" - "+shortcutName(keyCode,tool.shiftKey||tool.modeShiftKey);}
if(tool.hideText!==true){paragraph.textContent=title;if(tool.isEnabled){if(tool.isEnabled()){div.className="tool enabled";}else{div.className="tool";}}}}
function select(parameter,shiftKey){var initializer;if((selected&&(selected.tool.uid===tool.uid))){if(tool.modeChange){tool.modeChange(shiftKey);updateStatus();editor.fireCustomEvent("current-tool",tool.toString());}
if(parameter&&tool[parameter]){tool[parameter]();}}else{if(tool.init){initializer=shiftKey?(tool.shiftKey||tool.init):tool.init;if(tool.isModal){div.className="tool modal-on";}
if(initializer()){if(selected){selected.div.className="tool";selected.tool.remove();}
selected={"div":div,"tool":tool};div.className="tool selected";editor.fireCustomEvent("current-tool",tool.toString());}}
if(parameter&&tool[parameter]){tool[parameter](shiftKey);}
updateStatus();}}
function animationEnd(){div.className="tool";}
div=ElementHelper.create("div",{"className":"tool"});if(tool.hideText===true){div.className+=" hide-text";}
div.addEventListener("mousedown",function(evt){evt.preventDefault();select(undefined,evt.which===3);},false);div.addEventListener("contextmenu",function(evt){evt.preventDefault();},false);div.addEventListener("animationend",animationEnd,false);div.addEventListener("webkitAnimationEnd",animationEnd,false);tools[tool.uid]={"select":select,"onload":tool.onload,"updateStatus":updateStatus,"sampleBlock":tool.sampleBlock,"div":div,"getState":tool.getState,"setState":tool.setState};if(tool.hideText!==true){if(keyCode){shortcuts[keyCode]={"select":select};paragraph=ElementHelper.create("p",{"textContent":tool.toString()+" - "+shortcutName(keyCode,tool.shiftKey||tool.modeShiftKey)});}else{paragraph=ElementHelper.create("p",{"textContent":tool.toString()});}
div.appendChild(paragraph);}
if(functionKeys){Object.keys(functionKeys).forEach(function(parameter){functionShortcuts[functionKeys[parameter]]={"select":select,"parameter":parameter};});}
if(tool.canvas!==undefined){tool.canvas.style.verticalAlign="bottom";divCanvasContainer=ElementHelper.create("div");if(tool.canvas.style.width!==undefined){divCanvasContainer.style.width=tool.canvas.style.width;}else{divCanvasContainer.style.width=tool.canvas.width+"px";}
if(tool.hideText!==true){divCanvasContainer.style.margin="4px auto";}else{divCanvasContainer.style.margin="0px auto";}
divCanvasContainer.appendChild(tool.canvas);div.appendChild(divCanvasContainer);tools[tool.uid].divCanvasContainer=divCanvasContainer;tools[tool.uid].canvas=tool.canvas;}
if(tool.quickAccess!==undefined){quickAccessPanel.appendChild(tool.quickAccess);tools[tool.uid].quickAccess=tool.quickAccess;}
if(tool.quickFontAccess!==undefined){quickFontAccessPanel.appendChild(tool.quickFontAccess);tools[tool.uid].quickFontAccess=tool.quickFontAccess;}
document.getElementById(elementId).appendChild(div);if(tool.autoselect){select();}
return{"select":select};}
function getCurrentTool(){if(selected!==undefined){return selected.tool.uid;}
return undefined;}
function getStates(){var states;states={};Object.keys(tools).forEach(function(key){if(tools[key].getState!==undefined){states[key]=tools[key].getState();}});return states;}
function setStates(states){Object.keys(states).forEach(function(uid){if(states[uid].length!==0&&tools[uid]!==undefined){tools[uid].setState(states[uid]);tools[uid].updateStatus();}});}
function keydown(evt){var keyCode,resizeEvent;keyCode=evt.keyCode||evt.which;if(keyCode===27){evt.preventDefault();document.getElementById("container").className=proMode?"":"pro";proMode=!proMode;resizeEvent=document.createEvent("Event");resizeEvent.initEvent("resize",true,true);window.dispatchEvent(resizeEvent);}else if((keyCode>=112&&keyCode<=122)||(keyCode>=49&&keyCode<=56)||keyCode===9){evt.preventDefault();if(functionShortcuts[keyCode]){functionShortcuts[keyCode].select(functionShortcuts[keyCode].parameter,evt.shiftKey);}}else if(keyCode===81&&!quickAccessDisplayed){evt.preventDefault();quickAccessPanel.style.left=(mousePos.x-quickAccessOffset.x)+"px";quickAccessPanel.style.top=(mousePos.y-quickAccessOffset.y)+"px";document.body.appendChild(quickAccessPanel);quickAccessDisplayed=true;}else if(keyCode===87&&!quickFontAccessDisplayed){evt.preventDefault();quickFontAccessPanel.style.left=(mousePos.x-quickFontAccessOffset.x)+"px";quickFontAccessPanel.style.top=(mousePos.y-quickFontAccessOffset.y)+"px";document.body.appendChild(quickFontAccessPanel);quickFontAccessDisplayed=true;}}
function keyup(evt){var keyCode;keyCode=evt.keyCode||evt.which;if(keyCode===81&&quickAccessDisplayed){evt.preventDefault();document.body.removeChild(quickAccessPanel);quickAccessDisplayed=false;}else if(keyCode===87&&quickFontAccessDisplayed){evt.preventDefault();document.body.removeChild(quickFontAccessPanel);quickFontAccessDisplayed=false;}}
function keypress(evt){var keyCode;keyCode=evt.keyCode||evt.which;if(keyCode>=65&&keyCode<=90){keyCode+=32;}
if(shortcuts[keyCode]&&!evt.metaKey){evt.preventDefault();shortcuts[keyCode].select(undefined,evt.shiftKey);}}
document.addEventListener("mousemove",function(evt){mousePos={"x":evt.clientX,"y":evt.clientY};},false);function updateQuickPanelOffset(evt){var pos;pos=evt.currentTarget.getBoundingClientRect();quickAccessOffset={"x":evt.clientX-pos.left,"y":evt.clientY-pos.top};}
function updateQuickFontPanelOffset(evt){var pos;pos=evt.currentTarget.getBoundingClientRect();quickFontAccessOffset={"x":evt.clientX-pos.left,"y":evt.clientY-pos.top};}
quickAccessPanel.addEventListener("mousedown",updateQuickPanelOffset,false);quickFontAccessPanel.addEventListener("mousedown",updateQuickFontPanelOffset,false);quickAccessPanel.addEventListener("mousemove",function(evt){var mouseButton;mouseButton=(evt.buttons!==undefined)?evt.buttons:evt.which;if(mouseButton){updateQuickPanelOffset(evt);}},false);quickFontAccessPanel.addEventListener("mousemove",function(evt){var mouseButton;mouseButton=(evt.buttons!==undefined)?evt.buttons:evt.which;if(mouseButton){updateQuickFontPanelOffset(evt);}},false);function startListening(){document.addEventListener("keydown",keydown,false);document.addEventListener("keyup",keyup,false);document.addEventListener("keypress",keypress,false);}
function stopListening(){document.removeEventListener("keydown",keydown);document.removeEventListener("keyup",keyup);document.removeEventListener("keypress",keypress);}
function giveFocus(uid){if(tools[uid]){tools[uid].select();}}
function init(titleRef){startListening();title=titleRef;}
function onload(){Object.keys(tools).forEach(function(key){if(tools[key].onload!==undefined){tools[key].onload();}});}
function updateStatus(uid){if(tools[uid]!==undefined){tools[uid].updateStatus();}}
function replaceCanvas(uid,canvas){if(tools[uid]!==undefined&&tools[uid].divCanvasContainer!==undefined){tools[uid].divCanvasContainer.removeChild(tools[uid].canvas);canvas.style.verticalAlign="bottom";if(canvas.style.width!==undefined){tools[uid].divCanvasContainer.style.width=canvas.style.width;}else{tools[uid].divCanvasContainer.style.width=canvas.width+"px";}
tools[uid].canvas=canvas;tools[uid].divCanvasContainer.appendChild(canvas);}}
function replaceQuickAccess(uid,quickAccess){if(tools[uid]!==undefined&&tools[uid].quickAccess!==undefined){quickAccessPanel.removeChild(tools[uid].quickAccess);quickAccess.style.verticalAlign="bottom";tools[uid].quickAccess=quickAccess;quickAccessPanel.appendChild(quickAccess);quickAccessOffset={"x":8,"y":8};}}
function replaceQuickFontAccess(uid,quickFontAccess){if(tools[uid]!==undefined&&tools[uid].quickFontAccess!==undefined){quickFontAccessPanel.removeChild(tools[uid].quickFontAccess);quickFontAccess.style.verticalAlign="bottom";tools[uid].quickFontAccess=quickFontAccess;quickFontAccessPanel.appendChild(quickFontAccess);quickFontAccessOffset={"x":8,"y":8};}}
function changeToolClassName(uid,newClassName){if(tools[uid]!==undefined){tools[uid].div.className="tool "+newClassName;}}
function flashGreen(uid){changeToolClassName(uid,"flash");}
function flashRed(uid){changeToolClassName(uid,"flash-red");}
function modalEnd(uid){if(tools[uid]!==undefined){tools[uid].div.className="tool";}}
function sampleBlock(block){Object.keys(tools).forEach(function(key){if(tools[key].sampleBlock!==undefined){if(tools[key].sampleBlock(block)){tools[key].select();return;}}});}
function getTitleText(){return title.getText();}
function setTitleText(text){title.setText(text);}
function clearTitleText(){title.clearText();}
return{"init":init,"editor":editor,"addTool":addTool,"sampleBlock":sampleBlock,"getCurrentTool":getCurrentTool,"getStates":getStates,"setStates":setStates,"startListening":startListening,"stopListening":stopListening,"giveFocus":giveFocus,"updateStatus":updateStatus,"replaceCanvas":replaceCanvas,"replaceQuickAccess":replaceQuickAccess,"replaceQuickFontAccess":replaceQuickFontAccess,"flashGreen":flashGreen,"flashRed":flashRed,"modalEnd":modalEnd,"getTitleText":getTitleText,"setTitleText":setTitleText,"clearTitleText":clearTitleText,"onload":onload};}function modalBox(){"use strict";var divOverlay,divModalBox;divOverlay=ElementHelper.create("div",{"className":"screen-overlay"});divModalBox=ElementHelper.create("div",{"className":"modal-box"});function addButton(className,args){var paragraph,div,anchor;div=ElementHelper.create("div",{"className":"button-box "+className});paragraph=ElementHelper.create("p",{});anchor=ElementHelper.create("a",args);paragraph.appendChild(anchor);div.appendChild(paragraph);divModalBox.appendChild(div);}
function addPanel(element){divModalBox.appendChild(element);}
function init(){divOverlay.appendChild(divModalBox);document.body.appendChild(divOverlay);}
function remove(){document.body.removeChild(divOverlay);}
return{"init":init,"remove":remove,"addButton":addButton,"addPanel":addPanel};}function codepageGenerator(){"use strict";var BASE64_CHARS,currentBytes,currentFont,currentPalette,currentRGBAColors,fontDataBuffer,upperBlockBuffer,lowerBlockBuffer,fullBlockBuffer,NULL,DATA_LINK_ESCAPE,DEVICE_CONTROL_1,CANCEL,END_OF_MEDIUM,SUBSTITUTE,ESCAPE,RECORD_SEPERATOR,UNIT_SEPERATOR,SPACE,EXCLAMATION_MARK,LEFT_PARENTHESIS,RIGHT_PARENTHESIS,SOLIDUS,LESS_THAN_SIGN,GREATER_THAN_SIGN,LEFT_SQUARE_BRACKET,REVERSE_SOLIDUS,RIGHT_SQUARE_BRACKET,LEFT_CURLY_BRACKET,RIGHT_CURLY_BRACKET,C_CEDILLA,REVERSED_NOT_SIGN,NOT_SIGN,INVERTED_EXCLAMATION_MARK,LEFT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK,RIGHT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK,LIGHT_SHADE,MEDIUM_SHADE,DARK_SHADE,BOX_DRAWINGS_LIGHT_VERTICAL_AND_LEFT,BOX_DRAWINGS_VERTICAL_SINGLE_AND_LEFT_DOUBLE,BOX_DRAWINGS_VERTICAL_DOUBLE_AND_LEFT_SINGLE,BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE,BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE,BOX_DRAWINGS_DOUBLE_VERTICAL_AND_LEFT,BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT,BOX_DRAWINGS_DOUBLE_UP_AND_LEFT,BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE,BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE,BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT,BOX_DRAWINGS_LIGHT_UP_AND_RIGHT,BOX_DRAWINGS_LIGHT_UP_AND_HORIZONTAL,BOX_DRAWINGS_LIGHT_DOWN_AND_HORIZONTAL,BOX_DRAWINGS_LIGHT_VERTICAL_AND_RIGHT,BOX_DRAWINGS_VERTICAL_SINGLE_AND_RIGHT_DOUBLE,BOX_DRAWINGS_VERTICAL_DOUBLE_AND_RIGHT_SINGLE,BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT,BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT,BOX_DRAWINGS_DOUBLE_UP_AND_HORIZONTAL,BOX_DRAWINGS_DOUBLE_DOWN_AND_HORIZONTAL,BOX_DRAWINGS_DOUBLE_VERTICAL_AND_RIGHT,BOX_DRAWINGS_UP_SINGLE_AND_HORIZONTAL_DOUBLE,BOX_DRAWINGS_UP_DOUBLE_AND_HORIZONTAL_SINGLE,BOX_DRAWINGS_DOWN_SINGLE_AND_HORIZONTAL_DOUBLE,BOX_DRAWINGS_DOWN_DOUBLE_AND_HORIZONTAL_SINGLE,BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE,BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE,BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE,BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE,BOX_DRAWINGS_LIGHT_UP_AND_LEFT,BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT,FULL_BLOCK,LOWER_HALF_BLOCK,LEFT_HALF_BLOCK,RIGHT_HALF_BLOCK,UPPER_HALF_BLOCK,GREATER_THAN_OR_EQUAL_TO,LESS_THAN_OR_EQUAL_TO,BULLET_OPERATOR,MIDDLE_DOT,MIDDLE_BLOCK,NO_BREAK_SPACE;NULL=0;DATA_LINK_ESCAPE=16;DEVICE_CONTROL_1=17;CANCEL=24;END_OF_MEDIUM=25;SUBSTITUTE=26;ESCAPE=27;RECORD_SEPERATOR=30;UNIT_SEPERATOR=31;SPACE=32;EXCLAMATION_MARK=33;LEFT_PARENTHESIS=40;RIGHT_PARENTHESIS=41;SOLIDUS=47;LESS_THAN_SIGN=60;GREATER_THAN_SIGN=62;LEFT_SQUARE_BRACKET=91;REVERSE_SOLIDUS=92;RIGHT_SQUARE_BRACKET=93;LEFT_CURLY_BRACKET=123;RIGHT_CURLY_BRACKET=125;C_CEDILLA=128;REVERSED_NOT_SIGN=169;NOT_SIGN=170;INVERTED_EXCLAMATION_MARK=173;LEFT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK=174;RIGHT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK=175;LIGHT_SHADE=176;MEDIUM_SHADE=177;DARK_SHADE=178;BOX_DRAWINGS_LIGHT_VERTICAL_AND_LEFT=180;BOX_DRAWINGS_VERTICAL_SINGLE_AND_LEFT_DOUBLE=181;BOX_DRAWINGS_VERTICAL_DOUBLE_AND_LEFT_SINGLE=182;BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE=183;BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE=184;BOX_DRAWINGS_DOUBLE_VERTICAL_AND_LEFT=185;BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT=187;BOX_DRAWINGS_DOUBLE_UP_AND_LEFT=188;BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE=189;BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE=190;BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT=191;BOX_DRAWINGS_LIGHT_UP_AND_RIGHT=192;BOX_DRAWINGS_LIGHT_UP_AND_HORIZONTAL=193;BOX_DRAWINGS_LIGHT_DOWN_AND_HORIZONTAL=194;BOX_DRAWINGS_LIGHT_VERTICAL_AND_RIGHT=195;BOX_DRAWINGS_VERTICAL_SINGLE_AND_RIGHT_DOUBLE=198;BOX_DRAWINGS_VERTICAL_DOUBLE_AND_RIGHT_SINGLE=199;BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT=200;BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT=201;BOX_DRAWINGS_DOUBLE_UP_AND_HORIZONTAL=202;BOX_DRAWINGS_DOUBLE_DOWN_AND_HORIZONTAL=203;BOX_DRAWINGS_DOUBLE_VERTICAL_AND_RIGHT=204;BOX_DRAWINGS_UP_SINGLE_AND_HORIZONTAL_DOUBLE=207;BOX_DRAWINGS_UP_DOUBLE_AND_HORIZONTAL_SINGLE=208;BOX_DRAWINGS_DOWN_SINGLE_AND_HORIZONTAL_DOUBLE=209;BOX_DRAWINGS_DOWN_DOUBLE_AND_HORIZONTAL_SINGLE=210;BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE=211;BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE=212;BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE=213;BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE=214;BOX_DRAWINGS_LIGHT_UP_AND_LEFT=217;BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT=218;FULL_BLOCK=219;LOWER_HALF_BLOCK=220;LEFT_HALF_BLOCK=221;RIGHT_HALF_BLOCK=222;UPPER_HALF_BLOCK=223;GREATER_THAN_OR_EQUAL_TO=242;LESS_THAN_OR_EQUAL_TO=243;BULLET_OPERATOR=249;MIDDLE_DOT=250;MIDDLE_BLOCK=254;NO_BREAK_SPACE=255;BASE64_CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";fontDataBuffer=[];upperBlockBuffer=[];lowerBlockBuffer=[];fullBlockBuffer=[];function bytesToBits(width,height,bytes){var bits,i,j,k;bits=new Uint8Array(width*height*256);for(i=0,k=0;i<width*height*256/8;i+=1){for(j=7;j>=0;j-=1,k+=1){bits[k]=(bytes[i]>>j)&1;}}
return{"bits":bits,"width":width,"height":height};}
function base64ToBits(width,height,base64){var i,j,bytes16,bytes8;bytes16=new Uint32Array(1);bytes8=new Uint8Array(base64.length/4*3);for(i=j=0;i<base64.length;bytes16[0]=0,i+=4,j+=3){bytes16[0]+=(BASE64_CHARS.indexOf(base64.charAt(i))&63)<<18;bytes16[0]+=(BASE64_CHARS.indexOf(base64.charAt(i+1))&63)<<12;bytes16[0]+=(BASE64_CHARS.indexOf(base64.charAt(i+2))&63)<<6;bytes16[0]+=BASE64_CHARS.indexOf(base64.charAt(i+3))&63;bytes8[j]=(bytes16[0]>>16)&255;bytes8[j+1]=(bytes16[0]>>8)&255;bytes8[j+2]=bytes16[0]&255;}
currentBytes=bytes8.subarray(0,height*256);return bytesToBits(width,height,bytes8);}
function flushBuffer(buffer){var i;for(i=0;i<buffer.length;i+=1){delete buffer[i];}}
function flushAllBuffers(){flushBuffer(fontDataBuffer);flushBuffer(upperBlockBuffer);flushBuffer(lowerBlockBuffer);flushBuffer(fullBlockBuffer);}
function setFontToDefault(){currentFont=base64ToBits(8,16,"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AAAAAAD8xvzGxvzAwMAAAAAA/sbGwMDAwMDAwAAAAAAAAAAAgP5sbGxsbGwAAAAAAAAA/sZgMBgwYMb+AAAAAAAAAAAAftjY2NjYcAAAAAAAAAAAZmZmZmZ8YGDAAAAAAAAAAHbcGBgYGBgYAAAAAAAAAH4YPGZmZjwYfgAAAAAAAAA4bMbG/sbGbDgAAAAAAAA4bMbGxmxsbGzuAAAAAAAAHjAYDD5mZmZmPAAAAAAAAAAAAH7b29t+AAAAAAAAAAAAAwZ+z9vzfmDAAAAAAAAAHDBgYHxgYGAwHAAAAAAAAAB8xsbGxsbGxsYAAAAAAAAAAP4AAP4AAP4AAAAAAAAAAAAYGH4YGAAA/wAAAAAAAAAwGAwGDBgwAH4AAAAAAAAADBgwYDAYDAB+AAAAAAAADhsbGBgYGBgYGBgYGBgYGBgYGBgYGNjY2HAAAAAAAAAAABgYAH4AGBgAAAAAAAAAAAAAdtwAdtwAAAAAAAAAOGxsOAAAAAAAAAAAAAAAAAAAAAAAABgYAAAAAAAAAAAAAAAAAAAAGAAAAAAAAAAADwwMDAwM7GxsPBwAAAAAANhsbGxsbAAAAAAAAAAAAABwmDBgyPgAAAAAAAAAAAAAAAAAfHx8fHx8fAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==");flushAllBuffers();}
function getFontWidth(){return currentFont.width;}
function getFontHeight(){return currentFont.height;}
function getFontBytes(){return currentBytes;}
function setFont(width,height,bytes){currentBytes=bytes;currentFont=bytesToBits(width,height,bytes);flushAllBuffers();}
function setPalette(palette){currentPalette=palette;currentRGBAColors=palette.map(function(value){return new Uint8Array([value[0]<<2|value[0]>>4,value[1]<<2|value[1]>>4,value[2]<<2|value[2]>>4,255]);});flushAllBuffers();}
function setPaletteToDefault(){setPalette([[0,0,0],[0,0,42],[0,42,0],[0,42,42],[42,0,0],[42,0,42],[42,21,0],[42,42,42],[21,21,21],[21,21,63],[21,63,21],[21,63,63],[63,21,21],[63,21,63],[63,63,21],[63,63,63]]);}
function getPalette(){return currentPalette;}
function getRGBAColor(color){return currentRGBAColors[color];}
function styleRGBA(color,alpha){return"rgba("+currentRGBAColors[color][0]+", "+currentRGBAColors[color][1]+", "+currentRGBAColors[color][2]+", "+alpha+")";}
function getData(charCode,fgRGBA,bgRGBA,font){var fontBitWidth,rgbaOutput,i,j,k;fontBitWidth=font.width*font.height;rgbaOutput=new Uint8Array(font.width*font.height*4);for(i=0,j=charCode*fontBitWidth,k=0;i<fontBitWidth;i+=1,j+=1){if(font.bits[j]===1){rgbaOutput.set(fgRGBA,k);}else{rgbaOutput.set(bgRGBA,k);}
k+=4;}
return rgbaOutput;}
function fontData(charCode,fg,bg){var bufferIndex;bufferIndex=charCode+(fg<<8)+(bg<<12);if(!fontDataBuffer[bufferIndex]){fontDataBuffer[bufferIndex]=getData(charCode,currentRGBAColors[fg],currentRGBAColors[bg],currentFont);}
return fontDataBuffer[bufferIndex];}
function fontDataRGBA(charCode,fg_rgba,bg_rgba){return getData(charCode,fg_rgba,bg_rgba,currentFont);}
function upperBlock(fg){if(!upperBlockBuffer[fg]){upperBlockBuffer[fg]=getData(UPPER_HALF_BLOCK,currentRGBAColors[fg],new Uint8Array([0,0,0,0]),currentFont);}
return upperBlockBuffer[fg];}
function lowerBlock(fg){if(!lowerBlockBuffer[fg]){lowerBlockBuffer[fg]=getData(LOWER_HALF_BLOCK,currentRGBAColors[fg],new Uint8Array([0,0,0,0]),currentFont);}
return lowerBlockBuffer[fg];}
function fullBlock(fg){if(!fullBlockBuffer[fg]){fullBlockBuffer[fg]=getData(FULL_BLOCK,currentRGBAColors[fg],new Uint8Array([0,0,0,0]),currentFont);}
return fullBlockBuffer[fg];}
function getFlippedTextX(charCode){switch(charCode){case DATA_LINK_ESCAPE:return DEVICE_CONTROL_1;case SUBSTITUTE:return ESCAPE;case LEFT_PARENTHESIS:return RIGHT_PARENTHESIS;case SOLIDUS:return REVERSE_SOLIDUS;case LESS_THAN_SIGN:return GREATER_THAN_SIGN;case LEFT_SQUARE_BRACKET:return RIGHT_SQUARE_BRACKET;case LEFT_CURLY_BRACKET:return RIGHT_CURLY_BRACKET;case REVERSED_NOT_SIGN:return NOT_SIGN;case LEFT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK:return RIGHT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK;case BOX_DRAWINGS_LIGHT_VERTICAL_AND_LEFT:return BOX_DRAWINGS_LIGHT_VERTICAL_AND_RIGHT;case BOX_DRAWINGS_VERTICAL_SINGLE_AND_LEFT_DOUBLE:return BOX_DRAWINGS_VERTICAL_SINGLE_AND_RIGHT_DOUBLE;case BOX_DRAWINGS_VERTICAL_DOUBLE_AND_LEFT_SINGLE:return BOX_DRAWINGS_VERTICAL_DOUBLE_AND_RIGHT_SINGLE;case BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE:return BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE;case BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE:return BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE;case BOX_DRAWINGS_DOUBLE_VERTICAL_AND_LEFT:return BOX_DRAWINGS_DOUBLE_VERTICAL_AND_RIGHT;case BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT:return BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT;case BOX_DRAWINGS_DOUBLE_UP_AND_LEFT:return BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT;case BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE:return BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE;case BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE:return BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE;case BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT:return BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT;case BOX_DRAWINGS_LIGHT_UP_AND_RIGHT:return BOX_DRAWINGS_LIGHT_UP_AND_LEFT;case LEFT_HALF_BLOCK:return RIGHT_HALF_BLOCK;case GREATER_THAN_OR_EQUAL_TO:return LESS_THAN_OR_EQUAL_TO;case DEVICE_CONTROL_1:return DATA_LINK_ESCAPE;case ESCAPE:return SUBSTITUTE;case RIGHT_PARENTHESIS:return LEFT_PARENTHESIS;case REVERSE_SOLIDUS:return SOLIDUS;case GREATER_THAN_SIGN:return LESS_THAN_SIGN;case RIGHT_SQUARE_BRACKET:return LEFT_SQUARE_BRACKET;case RIGHT_CURLY_BRACKET:return LEFT_CURLY_BRACKET;case NOT_SIGN:return REVERSED_NOT_SIGN;case RIGHT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK:return LEFT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK;case BOX_DRAWINGS_LIGHT_VERTICAL_AND_RIGHT:return BOX_DRAWINGS_LIGHT_VERTICAL_AND_LEFT;case BOX_DRAWINGS_VERTICAL_SINGLE_AND_RIGHT_DOUBLE:return BOX_DRAWINGS_VERTICAL_SINGLE_AND_LEFT_DOUBLE;case BOX_DRAWINGS_VERTICAL_DOUBLE_AND_RIGHT_SINGLE:return BOX_DRAWINGS_VERTICAL_DOUBLE_AND_LEFT_SINGLE;case BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE:return BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE;case BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE:return BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE;case BOX_DRAWINGS_DOUBLE_VERTICAL_AND_RIGHT:return BOX_DRAWINGS_DOUBLE_VERTICAL_AND_LEFT;case BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT:return BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT;case BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT:return BOX_DRAWINGS_DOUBLE_UP_AND_LEFT;case BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE:return BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE;case BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE:return BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE;case BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT:return BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT;case BOX_DRAWINGS_LIGHT_UP_AND_LEFT:return BOX_DRAWINGS_LIGHT_UP_AND_RIGHT;case RIGHT_HALF_BLOCK:return LEFT_HALF_BLOCK;case LESS_THAN_OR_EQUAL_TO:return GREATER_THAN_OR_EQUAL_TO;default:return charCode;}}
function getFlippedTextY(charCode){switch(charCode){case CANCEL:return END_OF_MEDIUM;case RECORD_SEPERATOR:return UNIT_SEPERATOR;case EXCLAMATION_MARK:return INVERTED_EXCLAMATION_MARK;case BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE:return BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE;case BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE:return BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE;case BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT:return BOX_DRAWINGS_DOUBLE_UP_AND_LEFT;case BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT:return BOX_DRAWINGS_LIGHT_UP_AND_LEFT;case BOX_DRAWINGS_LIGHT_UP_AND_RIGHT:return BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT;case BOX_DRAWINGS_LIGHT_UP_AND_HORIZONTAL:return BOX_DRAWINGS_LIGHT_DOWN_AND_HORIZONTAL;case BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT:return BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT;case BOX_DRAWINGS_DOUBLE_UP_AND_HORIZONTAL:return BOX_DRAWINGS_DOUBLE_DOWN_AND_HORIZONTAL;case BOX_DRAWINGS_UP_SINGLE_AND_HORIZONTAL_DOUBLE:return BOX_DRAWINGS_DOWN_SINGLE_AND_HORIZONTAL_DOUBLE;case BOX_DRAWINGS_UP_DOUBLE_AND_HORIZONTAL_SINGLE:return BOX_DRAWINGS_DOWN_DOUBLE_AND_HORIZONTAL_SINGLE;case BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE:return BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE;case BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE:return BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE;case UPPER_HALF_BLOCK:return LOWER_HALF_BLOCK;case END_OF_MEDIUM:return CANCEL;case UNIT_SEPERATOR:return RECORD_SEPERATOR;case INVERTED_EXCLAMATION_MARK:return EXCLAMATION_MARK;case BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE:return BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE;case BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE:return BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE;case BOX_DRAWINGS_DOUBLE_UP_AND_LEFT:return BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT;case BOX_DRAWINGS_LIGHT_UP_AND_LEFT:return BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT;case BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT:return BOX_DRAWINGS_LIGHT_UP_AND_RIGHT;case BOX_DRAWINGS_LIGHT_DOWN_AND_HORIZONTAL:return BOX_DRAWINGS_LIGHT_UP_AND_HORIZONTAL;case BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT:return BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT;case BOX_DRAWINGS_DOUBLE_DOWN_AND_HORIZONTAL:return BOX_DRAWINGS_DOUBLE_UP_AND_HORIZONTAL;case BOX_DRAWINGS_DOWN_SINGLE_AND_HORIZONTAL_DOUBLE:return BOX_DRAWINGS_UP_SINGLE_AND_HORIZONTAL_DOUBLE;case BOX_DRAWINGS_DOWN_DOUBLE_AND_HORIZONTAL_SINGLE:return BOX_DRAWINGS_UP_DOUBLE_AND_HORIZONTAL_SINGLE;case BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE:return BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE;case BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE:return BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE;case LOWER_HALF_BLOCK:return UPPER_HALF_BLOCK;default:return charCode;}}
setFontToDefault();setPaletteToDefault();return{"getFontWidth":getFontWidth,"getFontHeight":getFontHeight,"getFontBytes":getFontBytes,"setFont":setFont,"setFontToDefault":setFontToDefault,"setPalette":setPalette,"setPaletteToDefault":setPaletteToDefault,"getPalette":getPalette,"getRGBAColor":getRGBAColor,"styleRGBA":styleRGBA,"fontData":fontData,"upperBlock":upperBlock,"lowerBlock":lowerBlock,"fullBlock":fullBlock,"fontDataRGBA":fontDataRGBA,"getFlippedTextX":getFlippedTextX,"getFlippedTextY":getFlippedTextY,"NULL":NULL,"CANCEL":CANCEL,"END_OF_MEDIUM":END_OF_MEDIUM,"SUBSTITUTE":SUBSTITUTE,"ESCAPE":ESCAPE,"RECORD_SEPERATOR":RECORD_SEPERATOR,"UNIT_SEPERATOR":UNIT_SEPERATOR,"SPACE":SPACE,"EXCLAMATION_MARK":EXCLAMATION_MARK,"LEFT_PARENTHESIS":LEFT_PARENTHESIS,"RIGHT_PARENTHESIS":RIGHT_PARENTHESIS,"SOLIDUS":SOLIDUS,"LESS_THAN_SIGN":LESS_THAN_SIGN,"GREATER_THAN_SIGN":GREATER_THAN_SIGN,"LEFT_SQUARE_BRACKET":LEFT_SQUARE_BRACKET,"REVERSE_SOLIDUS":REVERSE_SOLIDUS,"RIGHT_SQUARE_BRACKET":RIGHT_SQUARE_BRACKET,"LEFT_CURLY_BRACKET":LEFT_CURLY_BRACKET,"RIGHT_CURLY_BRACKET":RIGHT_CURLY_BRACKET,"C_CEDILLA":C_CEDILLA,"DATA_LINK_ESCAPE":DATA_LINK_ESCAPE,"REVERSED_NOT_SIGN":REVERSED_NOT_SIGN,"DEVICE_CONTROL_1":DEVICE_CONTROL_1,"NOT_SIGN":NOT_SIGN,"LEFT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK":LEFT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK,"INVERTED_EXCLAMATION_MARK":INVERTED_EXCLAMATION_MARK,"LIGHT_SHADE":LIGHT_SHADE,"MEDIUM_SHADE":MEDIUM_SHADE,"DARK_SHADE":DARK_SHADE,"BOX_DRAWINGS_LIGHT_VERTICAL_AND_LEFT":BOX_DRAWINGS_LIGHT_VERTICAL_AND_LEFT,"BOX_DRAWINGS_VERTICAL_SINGLE_AND_LEFT_DOUBLE":BOX_DRAWINGS_VERTICAL_SINGLE_AND_LEFT_DOUBLE,"BOX_DRAWINGS_VERTICAL_DOUBLE_AND_LEFT_SINGLE":BOX_DRAWINGS_VERTICAL_DOUBLE_AND_LEFT_SINGLE,"BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE":BOX_DRAWINGS_DOWN_DOUBLE_AND_LEFT_SINGLE,"BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE":BOX_DRAWINGS_DOWN_SINGLE_AND_LEFT_DOUBLE,"BOX_DRAWINGS_DOUBLE_VERTICAL_AND_LEFT":BOX_DRAWINGS_DOUBLE_VERTICAL_AND_LEFT,"BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT":BOX_DRAWINGS_DOUBLE_DOWN_AND_LEFT,"RIGHT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK":RIGHT_POINTING_DOUBLE_ANGLE_QUOTATION_MARK,"BOX_DRAWINGS_DOUBLE_UP_AND_LEFT":BOX_DRAWINGS_DOUBLE_UP_AND_LEFT,"BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE":BOX_DRAWINGS_UP_DOUBLE_AND_LEFT_SINGLE,"BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE":BOX_DRAWINGS_UP_SINGLE_AND_LEFT_DOUBLE,"BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT":BOX_DRAWINGS_LIGHT_DOWN_AND_LEFT,"BOX_DRAWINGS_LIGHT_UP_AND_RIGHT":BOX_DRAWINGS_LIGHT_UP_AND_RIGHT,"BOX_DRAWINGS_LIGHT_UP_AND_HORIZONTAL":BOX_DRAWINGS_LIGHT_UP_AND_HORIZONTAL,"BOX_DRAWINGS_LIGHT_DOWN_AND_HORIZONTAL":BOX_DRAWINGS_LIGHT_DOWN_AND_HORIZONTAL,"BOX_DRAWINGS_LIGHT_VERTICAL_AND_RIGHT":BOX_DRAWINGS_LIGHT_VERTICAL_AND_RIGHT,"BOX_DRAWINGS_VERTICAL_SINGLE_AND_RIGHT_DOUBLE":BOX_DRAWINGS_VERTICAL_SINGLE_AND_RIGHT_DOUBLE,"BOX_DRAWINGS_VERTICAL_DOUBLE_AND_RIGHT_SINGLE":BOX_DRAWINGS_VERTICAL_DOUBLE_AND_RIGHT_SINGLE,"BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT":BOX_DRAWINGS_DOUBLE_UP_AND_RIGHT,"BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT":BOX_DRAWINGS_DOUBLE_DOWN_AND_RIGHT,"BOX_DRAWINGS_DOUBLE_UP_AND_HORIZONTAL":BOX_DRAWINGS_DOUBLE_UP_AND_HORIZONTAL,"BOX_DRAWINGS_DOUBLE_DOWN_AND_HORIZONTAL":BOX_DRAWINGS_DOUBLE_DOWN_AND_HORIZONTAL,"BOX_DRAWINGS_DOUBLE_VERTICAL_AND_RIGHT":BOX_DRAWINGS_DOUBLE_VERTICAL_AND_RIGHT,"BOX_DRAWINGS_UP_SINGLE_AND_HORIZONTAL_DOUBLE":BOX_DRAWINGS_UP_SINGLE_AND_HORIZONTAL_DOUBLE,"BOX_DRAWINGS_UP_DOUBLE_AND_HORIZONTAL_SINGLE":BOX_DRAWINGS_UP_DOUBLE_AND_HORIZONTAL_SINGLE,"BOX_DRAWINGS_DOWN_SINGLE_AND_HORIZONTAL_DOUBLE":BOX_DRAWINGS_DOWN_SINGLE_AND_HORIZONTAL_DOUBLE,"BOX_DRAWINGS_DOWN_DOUBLE_AND_HORIZONTAL_SINGLE":BOX_DRAWINGS_DOWN_DOUBLE_AND_HORIZONTAL_SINGLE,"BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE":BOX_DRAWINGS_UP_DOUBLE_AND_RIGHT_SINGLE,"BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE":BOX_DRAWINGS_UP_SINGLE_AND_RIGHT_DOUBLE,"BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE":BOX_DRAWINGS_DOWN_SINGLE_AND_RIGHT_DOUBLE,"BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE":BOX_DRAWINGS_DOWN_DOUBLE_AND_RIGHT_SINGLE,"BOX_DRAWINGS_LIGHT_UP_AND_LEFT":BOX_DRAWINGS_LIGHT_UP_AND_LEFT,"BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT":BOX_DRAWINGS_LIGHT_DOWN_AND_RIGHT,"FULL_BLOCK":FULL_BLOCK,"LOWER_HALF_BLOCK":LOWER_HALF_BLOCK,"LEFT_HALF_BLOCK":LEFT_HALF_BLOCK,"RIGHT_HALF_BLOCK":RIGHT_HALF_BLOCK,"UPPER_HALF_BLOCK":UPPER_HALF_BLOCK,"GREATER_THAN_OR_EQUAL_TO":GREATER_THAN_OR_EQUAL_TO,"LESS_THAN_OR_EQUAL_TO":LESS_THAN_OR_EQUAL_TO,"BULLET_OPERATOR":BULLET_OPERATOR,"MIDDLE_DOT":MIDDLE_DOT,"MIDDLE_BLOCK":MIDDLE_BLOCK,"NO_BREAK_SPACE":NO_BREAK_SPACE};}
function editorCanvas(divEditor,columns,rows,noblink){"use strict";var codepage,canvas,ctx,imageData,image,currentColor,undoQueue,redoQueue,undoTypes,redoTypes,overlays,mirror,colorListeners,blinkModeChangeListeners,fontChangeListeners,paletteChangeListeners,mouseMoveListeners,mouseDownListeners,mouseDragListeners,mouseUpListeners,mouseOutListeners,overlayChangeListeners,canvasDrawListeners,customEventListeners,title,author,group,UNDO_FREEHAND,UNDO_CHUNK,UNDO_RESIZE;codepage=codepageGenerator();undoQueue=[];undoTypes=[];redoQueue=[];redoTypes=[];overlays={};mirror=false;colorListeners=[];blinkModeChangeListeners=[];fontChangeListeners=[];paletteChangeListeners=[];mouseMoveListeners=[];mouseDownListeners=[];mouseDragListeners=[];mouseUpListeners=[];mouseOutListeners=[];overlayChangeListeners=[];canvasDrawListeners=[];customEventListeners={};title="";author="";group="";UNDO_FREEHAND=0;UNDO_CHUNK=1;UNDO_RESIZE=2;function fireEvent(listeners,evt){listeners.forEach(function(listener){listener(evt);});}
function draw(charCode,x,y,fg,bg){imageData.data.set(codepage.fontData(charCode,fg,bg),0);ctx.putImageData(imageData,x*imageData.width,y*imageData.height);}
function update(index){draw(image[index],index/3%columns,Math.floor(index/(columns*3)),image[index+1],image[index+2]);fireEvent(canvasDrawListeners,[image[index],image[index+1],image[index+2],index]);}
function redraw(){var i;for(i=0;i<image.length;i+=3){update(i);}}
function resetCanvas(){var i;for(i=0;i<image.length;i+=3){image[i]=32;image[i+1]=7;image[i+2]=0;}}
function clearImage(){resetCanvas();redraw();title="";author="";group="";}
function getColumns(){return columns;}
function getRows(){return rows;}
function setMetadata(newTitle,newAuthor,newGroup){title=newTitle;author=newAuthor;group=newGroup;}
function getMetadata(){return{"title":title,"author":author,"group":group};}
function addListener(listeners,listener){listeners.push(listener);}
function removeListener(listeners,listener){var i;for(i=0;i<listeners.length;i+=1){if(listeners[i]===listener){listeners.splice(i,1);}}}
function addColorChangeListener(listener){addListener(colorListeners,listener);}
function removeColorChangeListener(listener){removeListener(colorListeners,listener);}
function addBlinkModeChangeListener(listener){addListener(blinkModeChangeListeners,listener);}
function removeBlinkModeChangeListener(listener){removeListener(blinkModeChangeListeners,listener);}
function addFontChangeListener(listener){addListener(fontChangeListeners,listener);}
function removeFontChangeListener(listener){removeListener(fontChangeListeners,listener);}
function addPaletteChangeListener(listener){addListener(paletteChangeListeners,listener);}
function removePaletteChangeListener(listener){removeListener(paletteChangeListeners,listener);}
function addMouseMoveListener(listener){addListener(mouseMoveListeners,listener);}
function removeMouseMoveListener(listener){removeListener(mouseMoveListeners,listener);}
function addMouseDownListener(listener){addListener(mouseDownListeners,listener);}
function removeMouseDownListener(listener){removeListener(mouseDownListeners,listener);}
function addMouseDragListener(listener){addListener(mouseDragListeners,listener);}
function removeMouseDragListener(listener){removeListener(mouseDragListeners,listener);}
function addMouseUpListener(listener){addListener(mouseUpListeners,listener);}
function removeMouseUpListener(listener){removeListener(mouseUpListeners,listener);}
function addMouseOutListener(listener){addListener(mouseOutListeners,listener);}
function removeMouseOutListener(listener){removeListener(mouseOutListeners,listener);}
function addOverlayChangeListener(listener){addListener(overlayChangeListeners,listener);}
function removeOverlayChangeListener(listener){removeListener(overlayChangeListeners,listener);}
function addCanvasDrawListener(listener){addListener(canvasDrawListeners,listener);}
function removeCanvasDrawListener(listener){removeListener(canvasDrawListeners,listener);}
function addCustomEventListener(uid,listener){if(customEventListeners[uid]===undefined){customEventListeners[uid]=[];}
addListener(customEventListeners[uid],listener);}
function removeCustomEventListener(uid,listener){if(customEventListeners[uid]!==undefined){removeListener(customEventListeners[uid],listener);}}
function fireCustomEvent(uid,evt){if(customEventListeners[uid]!==undefined){fireEvent(customEventListeners[uid],evt);}}
function setCurrentColor(color){currentColor=color;fireEvent(colorListeners,color);}
function getCurrentColor(){return currentColor;}
function storeUndo(block){undoQueue[0].push([block.charCode,block.foreground,block.background,block.index]);}
function set(charCode,fg,bg,index){image[index]=charCode;image[index+1]=fg;image[index+2]=bg;}
function getBlock(blockX,blockY){var index,textY,modBlockY,charCode,foreground,background,isBlocky,upperBlockColor,lowerBlockColor;textY=Math.floor(blockY/2);modBlockY=blockY%2;index=(textY*columns+blockX)*3;charCode=image[index];foreground=image[index+1];background=image[index+2];switch(charCode){case codepage.NULL:case codepage.SPACE:case codepage.NO_BREAK_SPACE:upperBlockColor=background;lowerBlockColor=background;isBlocky=true;break;case codepage.UPPER_HALF_BLOCK:upperBlockColor=foreground;lowerBlockColor=background;isBlocky=true;break;case codepage.LOWER_HALF_BLOCK:upperBlockColor=background;lowerBlockColor=foreground;isBlocky=true;break;case codepage.FULL_BLOCK:upperBlockColor=foreground;lowerBlockColor=foreground;isBlocky=true;break;default:if(foreground===background){isBlocky=true;upperBlockColor=foreground;lowerBlockColor=foreground;}else{isBlocky=false;}}
return{"index":index,"textX":blockX,"textY":textY,"blockX":blockX,"blockY":blockY,"isUpperHalf":(modBlockY===0),"isLowerHalf":(modBlockY===1),"charCode":charCode,"foreground":foreground,"background":background,"isBlocky":isBlocky,"upperBlockColor":upperBlockColor,"lowerBlockColor":lowerBlockColor};}
function rehashCanvas(){canvas=ElementHelper.create("canvas",{"width":codepage.getFontWidth()*columns,"height":codepage.getFontHeight()*rows,"style":{"verticalAlign":"bottom"}});ctx=canvas.getContext("2d");imageData=ctx.createImageData(codepage.getFontWidth(),codepage.getFontHeight());divEditor.appendChild(canvas);}
function createCanvas(){rehashCanvas();image=new Uint8Array(columns*rows*3);resetCanvas();}
function clearRedoHistory(){while(redoQueue.length){redoQueue.pop();redoTypes.pop();}}
function clearUndoHistory(){clearRedoHistory();while(undoQueue.length){undoQueue.pop();undoTypes.pop();}}
function optimizeUndo(undos){var lookup,i;lookup=new Uint8Array(columns*rows*4);for(i=0;i<undos.length;i+=1){if(lookup[undos[i][3]]===1){undos.splice(i,1);i-=1;}else{lookup[undos[i][3]]=1;}}}
function mirrorBlock(block){var halfWay=columns/2;if(block.blockX>=halfWay){return getBlock((halfWay-1)-(block.blockX-halfWay),block.blockY);}
return getBlock(halfWay+(halfWay-1-block.blockX),block.blockY);}
function setTextBlock(block,charCode,fg,bg){storeUndo(block);set(charCode,fg,bg,block.index);update(block.index);if(mirror){charCode=codepage.getFlippedTextX(charCode);block=mirrorBlock(block);storeUndo(block);set(charCode,fg,bg,block.index);update(block.index);}}
function getTextBlock(textX,textY){return getBlock(textX,textY*2);}
function getImageData(textX,textY,width,height){var data,i,k,byteWidth,screenWidth;data=new Uint8Array(width*height*3);byteWidth=width*3;screenWidth=columns*3;for(i=0,k=(textY*columns+textX)*3;i<data.length;i+=byteWidth,k+=screenWidth){data.set(image.subarray(k,k+byteWidth),i);}
return{"width":width,"height":height,"data":data};}
function putImageData(inputImageData,textX,textY,alpha){var y,x,i,block;for(y=0,i=0;y<inputImageData.height;y+=1){if(textY+y>=rows){break;}
if(textY+y>=0){for(x=0;x<inputImageData.width;x+=1,i+=3){if(textX+x>=0&&textX+x<columns){block=getTextBlock(textX+x,textY+y);if(!alpha||inputImageData.data[i]!==codepage.SPACE){setTextBlock(block,inputImageData.data[i],inputImageData.data[i+1],inputImageData.data[i+2]);update(block.index);}}}}else{i+=inputImageData.width*3;}}}
function renderImageData(inputImageData,preserveTransparency){var fontWidth,fontHeight,imageDataCanvas,imageDataCtx,y,x,i;fontWidth=codepage.getFontWidth();fontHeight=codepage.getFontHeight();imageDataCanvas=ElementHelper.create("canvas",{"width":inputImageData.width*fontWidth,"height":inputImageData.height*fontHeight});imageDataCtx=imageDataCanvas.getContext("2d");for(y=0,i=0;y<inputImageData.height;y+=1){for(x=0;x<inputImageData.width;x+=1,i+=3){if(!preserveTransparency||inputImageData.data[i]!==codepage.SPACE){imageData.data.set(codepage.fontData(inputImageData.data[i],inputImageData.data[i+1],inputImageData.data[i+2]),0);imageDataCtx.putImageData(imageData,x*fontWidth,y*fontHeight);}}}
return imageDataCanvas;}
function resolveConflict(blockIndex,colorBias,color){var block;block=getBlock(blockIndex/3%columns,Math.floor(blockIndex/3/columns)*2);if(block.background>7){if(block.isBlocky){if(block.foreground>7){if(colorBias){if(block.upperBlockColor===color&&block.lowerBlockColor===color){set(codepage.FULL_BLOCK,color,0,block.index);}else if(block.upperBlockColor===color){set(codepage.UPPER_HALF_BLOCK,block.upperBlockColor,block.lowerBlockColor-8,block.index);}else if(block.lowerBlockColor===color){set(codepage.LOWER_HALF_BLOCK,block.lowerBlockColor,block.upperBlockColor-8,block.index);}else{set(image[block.index],block.foreground,block.background-8,block.index);}}else{if(block.upperBlockColor===color&&block.lowerBlockColor===color){set(codepage.FULL_BLOCK,color,0,block.index);}else if(block.upperBlockColor===color){set(codepage.LOWER_HALF_BLOCK,block.lowerBlockColor,block.upperBlockColor-8,block.index);}else if(block.lowerBlockColor===color){set(codepage.UPPER_HALF_BLOCK,block.upperBlockColor,block.lowerBlockColor-8,block.index);}else{set(image[block.index],block.foreground,block.background-8,block.index);}}}else{if((block.upperBlockColor===block.background)&&(block.lowerBlockColor===block.background)){set(codepage.FULL_BLOCK,block.background,block.foreground,block.index);}else if(block.upperBlockColor===block.background){set(codepage.UPPER_HALF_BLOCK,block.background,block.foreground,block.index);}else if(block.lowerBlockColor===block.background){set(codepage.LOWER_HALF_BLOCK,block.background,block.foreground,block.index);}else{set(codepage.FULL_BLOCK,block.foreground,block.background-8,block.index);}}}else{set(image[block.index],block.foreground,block.background-8,block.index);}}}
function optimizeBlockAttributes(block,color){if(block.isBlocky){if(block.isUpperHalf){if(block.lowerBlockColor===color){set(codepage.FULL_BLOCK,color,block.background,block.index);}else{set(codepage.UPPER_HALF_BLOCK,color,block.lowerBlockColor,block.index);}}else{if(block.upperBlockColor===color){set(codepage.FULL_BLOCK,color,block.background,block.index);}else{set(codepage.LOWER_HALF_BLOCK,color,block.upperBlockColor,block.index);}}}else{if(block.isUpperHalf){set(codepage.UPPER_HALF_BLOCK,color,block.background,block.index);}else{set(codepage.LOWER_HALF_BLOCK,color,block.background,block.index);}}}
function setBlock(block,color,colorBias,colorBiasColor){storeUndo(block);optimizeBlockAttributes(block,color);if(!noblink){resolveConflict(block.index,colorBias,colorBiasColor);}
update(block.index);if(mirror){block=mirrorBlock(block);storeUndo(block);optimizeBlockAttributes(block,color);if(!noblink){resolveConflict(block.index,colorBias,colorBiasColor);}
update(block.index);}}
function setBlocks(colorBias,colorBiasColor,callback){var blockIndexes;blockIndexes=[];callback(function(block,color){storeUndo(block);optimizeBlockAttributes(block,color);blockIndexes.push(block.index);if(mirror){block=mirrorBlock(block);storeUndo(block);optimizeBlockAttributes(block,color);blockIndexes.push(block.index);}});blockIndexes.forEach(function(index){if(!noblink){resolveConflict(index,colorBias,colorBiasColor);}
update(index);});}
function setChar(block,charCode,color){storeUndo(block);if(block.isBlocky){if(block.isUpperHalf){set(charCode,color,block.upperBlockColor,block.index);}else{set(charCode,color,block.lowerBlockColor,block.index);}}else{set(charCode,color,block.background,block.index);}
if(!noblink){resolveConflict(block.index,true,color);}
update(block.index);if(mirror){charCode=codepage.getFlippedTextX(charCode);block=mirrorBlock(block);storeUndo(block);if(block.isBlocky){if(block.isUpperHalf){set(charCode,color,block.upperBlockColor,block.index);}else{set(charCode,color,block.lowerBlockColor,block.index);}}else{set(charCode,color,block.background,block.index);}
if(!noblink){resolveConflict(block.index,true,color);}
update(block.index);}}
function blockLine(from,to,callback,colorBias,colorBiasColor){var x0,y0,x1,y1,dx,dy,sx,sy,err,e2,block,blocks,i;function setBlockLineBlock(blockLineBlock,color){storeUndo(blockLineBlock);optimizeBlockAttributes(blockLineBlock,color);blocks.push(blockLineBlock.index);if(mirror){blockLineBlock=mirrorBlock(block);storeUndo(blockLineBlock);optimizeBlockAttributes(blockLineBlock,color);blocks.push(blockLineBlock.index);}}
x0=from.blockX;y0=from.blockY;x1=to.blockX;y1=to.blockY;dx=Math.abs(x1-x0);sx=(x0<x1)?1:-1;dy=Math.abs(y1-y0);sy=(y0<y1)?1:-1;err=((dx>dy)?dx:-dy)/2;blocks=[];while(true){block=getBlock(x0,y0);callback(block,setBlockLineBlock);if(x0===x1&&y0===y1){for(i=0;i<blocks.length;i+=1){if(!noblink){resolveConflict(blocks[i],colorBias,colorBiasColor);}
update(blocks[i]);}
break;}
e2=err;if(e2>-dx){err-=dy;x0+=sx;}
if(e2<dy){err+=dx;y0+=sy;}}}
function init(){var mouseButton;mouseButton=false;function canvasEvent(listeners,x,y,shiftKey,altKey,ctrlKey){var coord,blockX,blockY;blockX=Math.floor((x-divEditor.offsetLeft+divEditor.scrollLeft)/codepage.getFontWidth());blockY=Math.floor((y-divEditor.offsetTop+divEditor.scrollTop)/(codepage.getFontHeight()/2));if(blockX>=0&&blockY>=0&&blockX<columns&&blockY<rows*2){coord=getBlock(blockX,blockY);coord.shiftKey=shiftKey;coord.altKey=altKey;coord.ctrlKey=ctrlKey;fireEvent(listeners,coord);}}
divEditor.addEventListener("contextmenu",function(evt){evt.preventDefault();},false);divEditor.addEventListener("mousedown",function(evt){evt.preventDefault();if(!evt.ctrlKey){mouseButton=true;}
canvasEvent(mouseDownListeners,evt.clientX-canvas.offsetLeft,evt.clientY-canvas.offsetTop,evt.shiftKey,evt.altKey,evt.ctrlKey);},false);divEditor.addEventListener("mouseup",function(evt){evt.preventDefault();if(mouseButton){mouseButton=false;canvasEvent(mouseUpListeners,evt.clientX-canvas.offsetLeft,evt.clientY-canvas.offsetTop,evt.shiftKey,evt.altKey,evt.ctrlKey);}},false);divEditor.addEventListener("mousemove",function(evt){evt.preventDefault();if(mouseButton){canvasEvent(mouseDragListeners,evt.clientX-canvas.offsetLeft,evt.clientY-canvas.offsetTop,evt.shiftKey,evt.altKey,evt.ctrlKey);}else{canvasEvent(mouseMoveListeners,evt.clientX-canvas.offsetLeft,evt.clientY-canvas.offsetTop);}},false);divEditor.addEventListener("mouseleave",function(evt){evt.preventDefault();mouseButton=false;fireEvent(mouseOutListeners,undefined);},false);createCanvas();currentColor=7;redraw();}
function removeOverlay(uid){divEditor.removeChild(overlays[uid].canvas);delete overlays[uid];}
function isOverlayVisible(uid){return overlays[uid]!==undefined;}
function addOverlay(overlayCanvas,uid,redraw,zIndex){function realignOverlay(){overlayCanvas.style.left=canvas.offsetLeft+"px";}
if(overlays[uid]){removeOverlay(uid);}
overlayCanvas.style.zIndex=zIndex.toString(10);overlayCanvas.className="canvas-overlay";realignOverlay();window.addEventListener("resize",realignOverlay,false);divEditor.appendChild(overlayCanvas);overlays[uid]={"canvas":overlayCanvas,"redraw":redraw};}
function rehashOverlays(){fireEvent(overlayChangeListeners,undefined);Object.keys(overlays).forEach(function(uid){var overlay,zIndex,canvas;overlay=overlays[uid];zIndex=parseInt(overlay.canvas.style.zIndex,10);removeOverlay(uid);canvas=overlay.redraw();addOverlay(canvas,uid,overlay.redraw,zIndex);});}
function undo(){var values,redoValues,undoType,i,canvasIndex;if(undoQueue.length){undoType=undoTypes.shift();redoTypes.unshift(undoType);values=undoQueue.shift();if(undoType===UNDO_RESIZE){redoQueue.unshift([columns,rows,image.subarray(0,image.length)]);columns=values[0];rows=values[1];divEditor.removeChild(canvas);createCanvas();image.set(values[2],0);rehashOverlays();redraw();}else{redoValues=[];values.reverse();for(i=0;i<values.length;i+=1){canvasIndex=values[i][3];redoValues.push([image[canvasIndex],image[canvasIndex+1],image[canvasIndex+2],canvasIndex]);image[canvasIndex]=values[i][0];image[canvasIndex+1]=values[i][1];if(!noblink&&values[i][2]>=8){image[canvasIndex+2]=values[i][2]-8;}else{image[canvasIndex+2]=values[i][2];}
update(canvasIndex);}
redoQueue.unshift([redoValues.reverse(),values.reverse()]);values.reverse();}
return true;}
return false;}
function redo(){var values,redoType,i,updatedBlocks,canvasIndex;if(redoQueue.length){redoType=redoTypes.shift();undoTypes.unshift(redoType);values=redoQueue.shift();if(redoType===UNDO_RESIZE){undoQueue.unshift([columns,rows,image.subarray(0,image.length)]);columns=values[0];rows=values[1];divEditor.removeChild(canvas);createCanvas();image.set(values[2],0);rehashOverlays();redraw();}else{updatedBlocks=[];for(i=0;i<values[0].length;i+=1){canvasIndex=values[0][i][3];image[canvasIndex]=values[0][i][0];image[canvasIndex+1]=values[0][i][1];if(!noblink&&values[0][i][2]>=8){image[canvasIndex+2]=values[0][i][2]-8;}else{image[canvasIndex+2]=values[0][i][2];}
update(canvasIndex);updatedBlocks.push(values[0][i]);}
undoQueue.unshift(values[1].reverse());}
return true;}
return false;}
function startOfDrawing(typeOfUndo){clearRedoHistory();if(undoQueue.length!==0){if(undoQueue[0].length===0){undoQueue.splice(0,1);undoTypes.splice(0,1);}else{if(undoTypes[0]===UNDO_FREEHAND){optimizeUndo(undoQueue[0]);}}}
undoQueue.unshift([]);undoTypes.unshift(typeOfUndo);}
function startOfFreehand(){startOfDrawing(UNDO_FREEHAND);}
function startOfChunk(){startOfDrawing(UNDO_CHUNK);}
function endOfChunk(){optimizeUndo(undoQueue[0]);}
function getUndoHistory(){return{"queue":undoQueue,"types":undoTypes};}
function setUndoHistory(queue,types){clearUndoHistory();undoQueue=queue;undoTypes=types;}
function resize(newColumns,newRows){var oldColumns,oldRows,oldImage,x,y,sourceIndex,destIndex;clearRedoHistory();oldColumns=columns;oldRows=rows;columns=newColumns;rows=newRows;oldImage=image;divEditor.removeChild(canvas);createCanvas();undoQueue.unshift([oldColumns,oldRows,oldImage.subarray(0,oldImage.length)]);undoTypes.unshift(UNDO_RESIZE);for(y=0,destIndex=0;y<rows;y+=1){for(x=0;x<columns;x+=1,destIndex+=3){if(x<oldColumns&&y<oldRows){sourceIndex=(y*oldColumns+x)*3;image.set(oldImage.subarray(sourceIndex,sourceIndex+3),destIndex);}}}
rehashOverlays();redraw();}
function getBlinkStatus(){return noblink;}
function setBlinkStatus(value){var i;if(value!==noblink){noblink=value;if(!noblink){for(i=2;i<image.length;i+=3){if(image[i]>=8){image[i]-=8;update(i-2);}}}
fireEvent(blinkModeChangeListeners,noblink);}}
function notifyOfFontChange(){divEditor.removeChild(canvas);rehashCanvas();fireEvent(fontChangeListeners,undefined);rehashOverlays();redraw();}
function setFont(width,height,bytes){codepage.setFont(width,height,bytes);notifyOfFontChange();}
function setFontToDefault(){codepage.setFontToDefault();notifyOfFontChange();}
function notifyOfPaletteChange(){fireEvent(paletteChangeListeners,undefined);redraw();}
function setPalette(colors){codepage.setPalette(colors);notifyOfPaletteChange();}
function setPaletteToDefault(){codepage.setPaletteToDefault();notifyOfPaletteChange();}
function setImage(inputImageData){var i;clearUndoHistory();setBlinkStatus(inputImageData.noblink);columns=inputImageData.width;rows=inputImageData.height;title=inputImageData.title;author=inputImageData.author;group=inputImageData.group;if(inputImageData.font!==undefined){codepage.setFont(inputImageData.fontWidth,inputImageData.fontHeight,inputImageData.font);}else{codepage.setFontToDefault();}
if(inputImageData.palette!==undefined){codepage.setPalette(inputImageData.palette);}else{codepage.setPaletteToDefault();}
divEditor.removeChild(canvas);createCanvas();for(i=0;i<image.length;i+=3){image.set(inputImageData.data.subarray(i,i+3),i);}
rehashOverlays();fireEvent(fontChangeListeners,undefined);fireEvent(paletteChangeListeners,undefined);redraw();}
function setMirror(value){mirror=value;}
function centerOn(xPos,yPos){var size;size=divEditor.getBoundingClientRect();divEditor.scrollLeft=xPos-size.width/2;divEditor.scrollTop=yPos-size.height/2;}
return{"codepage":codepage,"init":init,"getColumns":getColumns,"getRows":getRows,"setMetadata":setMetadata,"getMetadata":getMetadata,"setCurrentColor":setCurrentColor,"getCurrentColor":getCurrentColor,"getRGBAColorFor":codepage.styleRGBA,"addColorChangeListener":addColorChangeListener,"removeColorChangeListener":removeColorChangeListener,"addBlinkModeChangeListener":addBlinkModeChangeListener,"removeBlinkModeChangeListener":removeBlinkModeChangeListener,"addFontChangeListener":addFontChangeListener,"removeFontChangeListener":removeFontChangeListener,"addPaletteChangeListener":addPaletteChangeListener,"removePaletteChangeListener":removePaletteChangeListener,"addMouseMoveListener":addMouseMoveListener,"removeMouseMoveListener":removeMouseMoveListener,"addMouseDownListener":addMouseDownListener,"removeMouseDownListener":removeMouseDownListener,"addMouseDragListener":addMouseDragListener,"removeMouseDragListener":removeMouseDragListener,"addMouseUpListener":addMouseUpListener,"removeMouseUpListener":removeMouseUpListener,"addMouseOutListener":addMouseOutListener,"removeMouseOutListener":removeMouseOutListener,"addOverlayChangeListener":addOverlayChangeListener,"removeOverlayChangeListener":removeOverlayChangeListener,"addCanvasDrawListener":addCanvasDrawListener,"removeCanvasDrawListener":removeCanvasDrawListener,"addCustomEventListener":addCustomEventListener,"removeCustomEventListener":removeCustomEventListener,"fireCustomEvent":fireCustomEvent,"clearImage":clearImage,"redraw":redraw,"resize":resize,"setImage":setImage,"getBlinkStatus":getBlinkStatus,"setBlinkStatus":setBlinkStatus,"setFont":setFont,"setFontToDefault":setFontToDefault,"setPalette":setPalette,"setPaletteToDefault":setPaletteToDefault,"getPalette":codepage.getPalette,"getBlock":getBlock,"setBlock":setBlock,"setBlocks":setBlocks,"getTextBlock":getTextBlock,"setTextBlock":setTextBlock,"getImageData":getImageData,"putImageData":putImageData,"renderImageData":renderImageData,"blockLine":blockLine,"setChar":setChar,"startOfFreehand":startOfFreehand,"startOfChunk":startOfChunk,"endOfChunk":endOfChunk,"undo":undo,"redo":redo,"getUndoHistory":getUndoHistory,"setUndoHistory":setUndoHistory,"clearUndoHistory":clearUndoHistory,"setMirror":setMirror,"addOverlay":addOverlay,"removeOverlay":removeOverlay,"isOverlayVisible":isOverlayVisible,"centerOn":centerOn};}function titleWidget(divTitle,editor,toolbar){"use strict";var title,currentTool;title=ElementHelper.create("p",{"className":"title","contentEditable":true,"spellcheck":false});divTitle.appendChild(title);currentTool=ElementHelper.create("p",{"className":"current-tool","textContent":""});divTitle.appendChild(currentTool);title.addEventListener("focus",function(){toolbar.stopListening();});function getText(){return title.textContent;}
function setText(text){title.textContent=text;}
function clearText(){setText("Untitled");}
title.addEventListener("keypress",function(evt){var keyCode;keyCode=evt.keyCode||evt.which;if(keyCode===13){evt.preventDefault();if(title.textContent.length===0){clearText();}
title.blur();toolbar.startListening();}else if(title.textContent.length===32){evt.preventDefault();}});editor.addCustomEventListener("current-tool",function(text){currentTool.textContent=text;});clearText();return{"getText":getText,"setText":setText,"clearText":clearText};}function charBrushTool(options){"use strict";return function(editor,toolbar){var currentColor,lastPoint,mode;mode=0;function colorChange(col){currentColor=col;}
function charBrush(block){editor.setChar(block,options.characters[mode].charCode,currentColor);}
function canvasDown(coord){if(coord.ctrlKey){toolbar.sampleBlock(coord);}else{if(coord.shiftKey&&lastPoint){editor.startOfChunk();editor.blockLine(lastPoint,coord,charBrush);editor.endOfChunk();}else{editor.startOfFreehand();charBrush(coord);}
lastPoint=coord;}}
function canvasDrag(coord){if(lastPoint){editor.blockLine(lastPoint,coord,charBrush);lastPoint=coord;}}
function init(){editor.addMouseDownListener(canvasDown);editor.addMouseDragListener(canvasDrag);editor.addColorChangeListener(colorChange);currentColor=editor.getCurrentColor();return true;}
function remove(){editor.removeMouseDownListener(canvasDown);editor.removeMouseDragListener(canvasDrag);editor.removeColorChangeListener(colorChange);}
function getState(){return[mode];}
function setState(bytes){mode=bytes[0];}
function modeChange(shiftKey){if(shiftKey){mode-=1;if(mode<0){mode=options.characters.length-1;}}else{mode+=1;if(mode===options.characters.length){mode=0;}}}
function toString(){return options.characters.length?options.name+": "+options.characters[mode].name:options.name;}
return{"init":init,"modeShiftKey":(options.characters.length>2),"remove":remove,"getState":getState,"setState":setState,"modeChange":modeChange,"toString":toString,"uid":"charbrush-"+options.uid};};}